<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>djm.pages.dev 内建音频播放器</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <style>
    /* 基础样式保持不变 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background-color: #F9FAFB;
      color: #1F2937;
      transition: background-color 0.3s ease;
    }
    body.dark {
      background-color: #111827;
      color: #F3F4F6;
    }
    .exit-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 6px 12px;
      background-color: rgba(255, 255, 255, 0.8);
      color: #3B82F6;
      border-radius: 6px;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 100;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
    }
    .title-container {
      position: absolute;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 1200px;
      text-align: center;
    }
    .audio-title {
      font-size: 4rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .progress-container {
      position: absolute;
      bottom: 35%;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 1200px;
    }
    .time-display {
      display: flex;
      justify-content: space-between;
      font-size: 1rem;
      color: #6B7280;
      margin-bottom: 8px;
    }
    /* 进度条恢复可拖动 */
    .progress-slider {
      -webkit-appearance: none;
      width: 100%;
      height: 3px;
      border-radius: 2px;
      background: #E2E8F0;
      outline: none;
    }
    .progress-slider::-webkit-slider-runnable-track {
      -webkit-appearance: none;
      height: 3px;
      background: linear-gradient(to right, #3B82F6 var(--progress, 0%), #E2E8F0 var(--progress, 0%));
    }
    .progress-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #3B82F6;
      cursor: pointer; /* 恢复可拖动光标 */
      margin-top: -5.5px;
      transition: transform 0.2s ease;
    }
    .progress-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }
    .controls-container {
      position: absolute;
      bottom: 10%;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .skip-btn {
      width: 80px;
      height: 60px;
      border-radius: 8px;
      background-color: #3B82F6;
      color: white;
      border: none;
      cursor: pointer;
      transition: all 0.25s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .skip-btn:hover {
      background-color: #2563EB;
    }
    /* 调大箭头图标 */
    .skip-icon {
      font-size: 2rem;
    }
    .play-btn {
      width: 112px;
      height: 112px;
      border-radius: 50%;
      background-color: #3B82F6;
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .play-icon {
      font-size: 2.5rem;
      margin-left: 6px;
    }
    .loading-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2rem;
      color: #3B82F6;
      display: none;
    }
    .loading-indicator.active {
      display: block;
      animation: spin 1.5s linear infinite;
    }
    @keyframes spin {
      from { transform: translate(-50%, -50%) rotate(0deg); }
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }
    /* 移动端适配 */
    @media (max-width: 768px) {
      .audio-title {
        font-size: 1.5rem;
      }
      .play-btn {
        width: 72px;
        height: 72px;
      }
      .skip-btn {
        width: 56px;
        height: 40px;
      }
      .skip-icon {
        font-size: 1.5rem;
      }
    }
  </style>
</head>

<body>
  <a href="https://djm.pages.dev/download-page.html" class="exit-btn">
    <i class="fa fa-sign-out mr-1"></i>退出播放
  </a>
  
  <div class="title-container">
    <h1 class="audio-title" id="audioTitle">未指定音频</h1>
  </div>
  
  <div class="progress-container">
    <div class="time-display">
      <span id="currentTime">00:00</span>
      <span id="totalTime">00:00</span>
    </div>
    <!-- 进度条恢复可拖动 -->
    <input type="range" id="progressBar" class="progress-slider" min="0" max="100" step="0.1" value="0">
  </div>
  
  <div class="controls-container">
    <!-- 添加title属性作为悬停提示 -->
    <button class="skip-btn" id="rewindBtn" title="后退20秒">
      <i class="fa fa-backward skip-icon"></i>
    </button>
    <button class="play-btn" id="playPauseBtn" title="暂停 / 播放">
      <i class="fa fa-play play-icon" id="playPauseIcon"></i>
    </button>
    <button class="skip-btn" id="forwardBtn" title="前进10秒">
      <i class="fa fa-forward skip-icon"></i>
    </button>
  </div>
  
  <div class="loading-indicator" id="loadingIndicator">
    <i class="fa fa-circle-o-notch fa-spin"></i>
  </div>
  
  <audio id="audioPlayer" preload="metadata"></audio>
  
  <script>
    // DOM元素
    const audioPlayer = document.getElementById('audioPlayer');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const playPauseIcon = document.getElementById('playPauseIcon');
    const progressBar = document.getElementById('progressBar');
    const currentTimeEl = document.getElementById('currentTime');
    const totalTimeEl = document.getElementById('totalTime');
    const audioTitle = document.getElementById('audioTitle');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const rewindBtn = document.getElementById('rewindBtn');
    const forwardBtn = document.getElementById('forwardBtn');
    
    // 状态变量
    let isPlaying = false;
    let audioLoaded = false;
    let totalDuration = 0;
    let lastValidTime = 0;
    let isDragging = false; // 用于跟踪进度条拖动状态
    
    // 初始化深色模式
    function initDarkMode() {
      if (window.matchMedia?.('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
      }
    }
    
    // 解析URL参数
    function parseURLParams() {
      const params = new URLSearchParams(window.location.search);
      const result = {};
      for (const [key, value] of params.entries()) {
        result[key] = decodeURIComponent(value);
      }
      return result;
    }
    
    // 处理音频加载
    function handleParams(params) {
      audioTitle.textContent = params.title || '未指定音频';
      if (params.url) {
        showLoading(true);
        audioPlayer.src = '';
        audioPlayer.load();
        audioPlayer.src = params.url;
        
        audioPlayer.addEventListener('loadedmetadata', onMetadataLoaded);
        audioPlayer.addEventListener('error', onAudioError);
        audioPlayer.addEventListener('timeupdate', trackValidTime);
      }
    }
    
    // 元数据加载完成
    function onMetadataLoaded() {
      audioLoaded = true;
      totalDuration = audioPlayer.duration;
      totalTimeEl.textContent = formatTime(totalDuration);
      showLoading(false);
      lastValidTime = 0;
    }
    
    // 音频错误处理
    function onAudioError(e) {
      showLoading(false);
      const errors = {
        1: "加载被中止",
        2: "网络错误（可能不支持跳转）",
        3: "音频损坏或无法解码",
        4: "格式不支持（建议用MP3）"
      };
      alert(`音频错误：${errors[e.target.error.code] || '未知错误'}`);
    }
    
    // 跟踪有效播放时间
    function trackValidTime() {
      if (audioLoaded && !isNaN(audioPlayer.currentTime) && audioPlayer.currentTime > 0 && !isDragging) {
        lastValidTime = audioPlayer.currentTime;
      }
      updateProgress();
    }
    
    // 时间格式化
    function formatTime(seconds) {
      if (isNaN(seconds) || seconds < 0) return "00:00";
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    
    // 更新进度条
    function updateProgress() {
      if (audioLoaded && totalDuration > 0) {
        const progressPercent = (lastValidTime / totalDuration) * 100;
        progressBar.style.setProperty('--progress', `${progressPercent}%`);
        progressBar.value = progressPercent;
        currentTimeEl.textContent = formatTime(lastValidTime);
      }
    }
    
    // 播放/暂停控制
    function playAudio() {
      if (!audioLoaded) return;
      
      showLoading(true);
      audioPlayer.play()
        .then(() => {
          isPlaying = true;
          playPauseIcon.classList.replace('fa-play', 'fa-pause');
          showLoading(false);
        })
        .catch(error => {
          showLoading(false);
          alert(`播放失败：${error.message}`);
        });
    }
    
    function pauseAudio() {
      if (!audioLoaded) return;
      
      audioPlayer.pause();
      isPlaying = false;
      playPauseIcon.classList.replace('fa-pause', 'fa-play');
    }
    
    // 后退20秒（修改为20秒）
    function rewind20s() {
      if (!audioLoaded) return;
      
      const newTime = Math.max(0, lastValidTime - 20);
      setAudioTime(newTime);
    }
    
    // 前进10秒
    function forward10s() {
      if (!audioLoaded) return;
      
      const newTime = Math.min(totalDuration, lastValidTime + 10);
      setAudioTime(newTime);
    }
    
    // 安全设置音频时间
    function setAudioTime(targetTime) {
      if (!audioLoaded) return;
      
      showLoading(true);
      const wasPlaying = isPlaying;
      
      audioPlayer.pause();
      
      requestAnimationFrame(() => {
        audioPlayer.currentTime = targetTime;
        
        setTimeout(() => {
          if (Math.abs(audioPlayer.currentTime - targetTime) > 1) {
            audioPlayer.currentTime = lastValidTime;
          } else {
            lastValidTime = targetTime;
          }
          
          updateProgress();
          showLoading(false);
          
          if (wasPlaying) {
            audioPlayer.play();
          }
        }, 300);
      });
    }
    
    // 进度条拖动控制
    function handleProgressStart() {
      if (!audioLoaded || totalDuration <= 0) return;
      
      isDragging = true;
      if (isPlaying) {
        audioPlayer.pause();
      }
    }
    
    function handleProgressDrag() {
      if (!audioLoaded || !isDragging || totalDuration <= 0) return;
      
      const progressPercent = parseFloat(progressBar.value);
      const clampedPercent = Math.max(0, Math.min(100, progressPercent));
      const targetTime = (clampedPercent / 100) * totalDuration;
      
      progressBar.style.setProperty('--progress', `${clampedPercent}%`);
      currentTimeEl.textContent = formatTime(targetTime);
    }
    
    function handleProgressEnd() {
      if (!audioLoaded || !isDragging || totalDuration <= 0) {
        isDragging = false;
        return;
      }
      
      const progressPercent = parseFloat(progressBar.value);
      const clampedPercent = Math.max(0, Math.min(100, progressPercent));
      const targetTime = (clampedPercent / 100) * totalDuration;
      
      setAudioTime(targetTime);
      isDragging = false;
    }
    
    // 播放结束处理
    function handleAudioEnded() {
      pauseAudio();
      lastValidTime = 0;
      audioPlayer.currentTime = 0;
      updateProgress();
    }
    
    // 显示加载状态
    function showLoading(show) {
      loadingIndicator.classList.toggle('active', show);
    }
    
    // 绑定事件
    function bindEvents() {
      playPauseBtn.addEventListener('click', () => isPlaying ? pauseAudio() : playAudio());
      rewindBtn.addEventListener('click', rewind20s);
      forwardBtn.addEventListener('click', forward10s);
      
      // 进度条事件
      progressBar.addEventListener('mousedown', handleProgressStart);
      progressBar.addEventListener('touchstart', (e) => {
        e.preventDefault();
        handleProgressStart();
      });
      progressBar.addEventListener('input', handleProgressDrag);
      progressBar.addEventListener('mouseup', handleProgressEnd);
      progressBar.addEventListener('touchend', (e) => {
        e.preventDefault();
        handleProgressEnd();
      });
      
      audioPlayer.addEventListener('ended', handleAudioEnded);
      audioPlayer.addEventListener('waiting', () => showLoading(true));
      audioPlayer.addEventListener('playing', () => showLoading(false));
      
      // 键盘控制
      document.addEventListener('keydown', (e) => {
        if (e.code === 'Space') {
          e.preventDefault();
          isPlaying ? pauseAudio() : playAudio();
        } else if (e.code === 'ArrowLeft') {
          e.preventDefault();
          rewind20s();
        } else if (e.code === 'ArrowRight') {
          e.preventDefault();
          forward10s();
        }
      });
    }
    
    // 初始化
    window.addEventListener('DOMContentLoaded', () => {
      initDarkMode();
      const params = parseURLParams();
      handleParams(params);
      bindEvents();
    });
  </script>
</body>
</html>