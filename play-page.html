<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>丁佳铭网页内置音频播放器</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <style>
    /* 保持原有样式不变 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background-color: #F9FAFB;
      color: #1F2937;
      transition: background-color 0.3s ease;
    }
    body.dark {
      background-color: #111827;
      color: #F3F4F6;
    }
    .exit-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 6px 12px;
      background-color: rgba(255, 255, 255, 0.8);
      color: #3B82F6;
      border-radius: 6px;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 100;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
    }
    .title-container {
      position: absolute;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 1200px;
      text-align: center;
    }
    .audio-title {
      font-size: 4rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .progress-container {
      position: absolute;
      bottom: 35%;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 1200px;
    }
    .time-display {
      display: flex;
      justify-content: space-between;
      font-size: 1rem;
      color: #6B7280;
      margin-bottom: 8px;
    }
    .progress-slider {
      -webkit-appearance: none;
      width: 100%;
      height: 3px;
      border-radius: 2px;
      background: #E2E8F0;
      outline: none;
    }
    .progress-slider::-webkit-slider-runnable-track {
      -webkit-appearance: none;
      height: 3px;
      background: linear-gradient(to right, #3B82F6 var(--progress, 0%), #E2E8F0 var(--progress, 0%));
    }
    .progress-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #3B82F6;
      cursor: pointer;
      margin-top: -5.5px;
      transition: transform 0.2s ease;
    }
    .progress-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }
    .controls-container {
      position: absolute;
      bottom: 10%;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .skip-btn {
      width: 80px;
      height: 60px;
      border-radius: 8px;
      background-color: #3B82F6;
      color: white;
      border: none;
      cursor: pointer;
      transition: all 0.25s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .skip-btn:hover {
      background-color: #2563EB;
    }
    .skip-icon {
      font-size: 2rem;
    }
    .play-btn {
      width: 112px;
      height: 112px;
      border-radius: 50%;
      background-color: #3B82F6;
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .play-icon {
      font-size: 2.5rem;
      margin-left: 6px;
    }
    .loading-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2rem;
      color: #3B82F6;
      display: none;
    }
    .loading-indicator.active {
      display: block;
      animation: spin 1.5s linear infinite;
    }
    .network-hint {
      position: absolute;
      bottom: 5%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.9rem;
      color: #6B7280;
      display: none;
    }
    .network-hint.active {
      display: block;
    }
    @keyframes spin {
      from { transform: translate(-50%, -50%) rotate(0deg); }
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }
    @media (max-width: 768px) {
      .audio-title {
        font-size: 1.5rem;
      }
      .play-btn {
        width: 72px;
        height: 72px;
      }
      .skip-btn {
        width: 56px;
        height: 40px;
      }
      .skip-icon {
        font-size: 1.5rem;
      }
    }
  </style>
</head>

<body>
  <a href="https://djm.pages.dev/download-page.html" class="exit-btn">
    <i class="fa fa-sign-out mr-1"></i>退出播放
  </a>
  
  <div class="title-container">
    <h1 class="audio-title" id="audioTitle">未指定音频</h1>
  </div>
  
  <div class="progress-container">
    <div class="time-display">
      <span id="currentTime">00:00</span>
      <span id="totalTime">00:00</span>
    </div>
    <input type="range" id="progressBar" class="progress-slider" min="0" max="100" step="0.1" value="0">
  </div>
  
  <div class="controls-container">
    <button class="skip-btn" id="rewindBtn" title="后退20秒">
      <i class="fa fa-backward skip-icon"></i>
    </button>
    <button class="play-btn" id="playPauseBtn">
      <i class="fa fa-play play-icon" id="playPauseIcon"></i>
    </button>
    <button class="skip-btn" id="forwardBtn" title="前进10秒">
      <i class="fa fa-forward skip-icon"></i>
    </button>
  </div>
  
  <div class="loading-indicator" id="loadingIndicator">
    <i class="fa fa-circle-o-notch fa-spin"></i>
  </div>
  
  <!-- 网络环境提示 -->
  <div class="network-hint" id="networkHint">网络音频加载中，首次跳转可能需要缓存时间...</div>
  
  <audio id="audioPlayer" preload="auto"></audio>
  
  <script>
    // DOM元素
    const audioPlayer = document.getElementById('audioPlayer');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const playPauseIcon = document.getElementById('playPauseIcon');
    const progressBar = document.getElementById('progressBar');
    const currentTimeEl = document.getElementById('currentTime');
    const totalTimeEl = document.getElementById('totalTime');
    const audioTitle = document.getElementById('audioTitle');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const rewindBtn = document.getElementById('rewindBtn');
    const forwardBtn = document.getElementById('forwardBtn');
    const networkHint = document.getElementById('networkHint');
    
    // 状态变量
    let isPlaying = false;
    let audioLoaded = false;
    let totalDuration = 0;
    let lastValidTime = 0;
    let isDragging = false;
    let isBuffering = false; // 标记是否正在缓冲
    
    // 初始化深色模式
    function initDarkMode() {
      if (window.matchMedia?.('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
      }
    }
    
    // 解析URL参数
    function parseURLParams() {
      const params = new URLSearchParams(window.location.search);
      const result = {};
      for (const [key, value] of params.entries()) {
        result[key] = decodeURIComponent(value);
      }
      return result;
    }
    
    // 检查服务器是否支持字节范围请求（关键：决定能否跳转）
    function checkRangeSupport(url) {
      return new Promise((resolve) => {
        const xhr = new XMLHttpRequest();
        xhr.open('HEAD', url);
        xhr.onload = () => {
          const acceptRanges = xhr.getResponseHeader('Accept-Ranges') === 'bytes';
          const contentLength = xhr.getResponseHeader('Content-Length');
          resolve({ 
            support: acceptRanges && !!contentLength,
            contentLength: contentLength
          });
        };
        xhr.onerror = () => resolve({ support: false });
        xhr.send();
      });
    }
    
    // 处理音频加载（网络环境专用）
    async function handleParams(params) {
      audioTitle.textContent = params.title || '未指定音频';
      if (params.url) {
        showLoading(true);
        networkHint.classList.add('active');
        
        // 关键步骤1：检查服务器是否支持跳转
        const rangeSupport = await checkRangeSupport(params.url);
        if (!rangeSupport.support) {
          alert('注意：当前音频服务器不支持直接跳转，首次跳转可能需要较长时间缓冲');
        }
        
        // 关键步骤2：使用缓存策略加载音频
        audioPlayer.src = '';
        audioPlayer.load();
        audioPlayer.src = params.url;
        audioPlayer.crossOrigin = "anonymous"; // 允许跨域缓存
        
        // 监听元数据加载
        audioPlayer.addEventListener('loadedmetadata', onMetadataLoaded);
        // 监听缓存进度（网络环境专用）
        audioPlayer.addEventListener('progress', updateBufferProgress);
        audioPlayer.addEventListener('error', onAudioError);
        audioPlayer.addEventListener('timeupdate', trackValidTime);
      }
    }
    
    // 显示缓冲进度（网络环境专用）
    function updateBufferProgress() {
      if (audioLoaded && audioPlayer.buffered.length > 0) {
        const bufferedEnd = audioPlayer.buffered.end(audioPlayer.buffered.length - 1);
        // 当缓冲足够时隐藏提示
        if (bufferedEnd / totalDuration > 0.5) {
          networkHint.classList.remove('active');
        }
      }
    }
    
    // 元数据加载完成
    function onMetadataLoaded() {
      audioLoaded = true;
      totalDuration = audioPlayer.duration;
      totalTimeEl.textContent = formatTime(totalDuration);
      showLoading(false);
      lastValidTime = 0;
    }
    
    // 音频错误处理
    function onAudioError(e) {
      showLoading(false);
      networkHint.classList.remove('active');
      const errors = {
        1: "加载被中止",
        2: "网络错误（请检查链接是否有效）",
        3: "音频损坏或无法解码",
        4: "格式不支持（建议使用MP3格式）"
      };
      alert(`音频错误：${errors[e.target.error.code] || '未知错误'}`);
    }
    
    // 跟踪有效播放时间
    function trackValidTime() {
      if (audioLoaded && !isNaN(audioPlayer.currentTime) && audioPlayer.currentTime > 0 && !isDragging) {
        lastValidTime = audioPlayer.currentTime;
      }
      updateProgress();
    }
    
    // 时间格式化
    function formatTime(seconds) {
      if (isNaN(seconds) || seconds < 0) return "00:00";
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    
    // 更新进度条
    function updateProgress() {
      if (audioLoaded && totalDuration > 0) {
        const progressPercent = (lastValidTime / totalDuration) * 100;
        progressBar.style.setProperty('--progress', `${progressPercent}%`);
        progressBar.value = progressPercent;
        currentTimeEl.textContent = formatTime(lastValidTime);
      }
    }
    
    // 播放/暂停控制
    function playAudio() {
      if (!audioLoaded) return;
      
      showLoading(true);
      audioPlayer.play()
        .then(() => {
          isPlaying = true;
          playPauseIcon.classList.replace('fa-play', 'fa-pause');
          showLoading(false);
        })
        .catch(error => {
          showLoading(false);
          alert(`播放失败：${error.message}`);
        });
    }
    
    function pauseAudio() {
      if (!audioLoaded) return;
      
      audioPlayer.pause();
      isPlaying = false;
      playPauseIcon.classList.replace('fa-pause', 'fa-play');
    }
    
    // 后退20秒
    function rewind20s() {
      if (!audioLoaded || isBuffering) return;
      jumpToTime(lastValidTime - 20);
    }
    
    // 前进10秒
    function forward10s() {
      if (!audioLoaded || isBuffering) return;
      jumpToTime(lastValidTime + 10);
    }
    
    // 进度条跳转
    function jumpToProgress() {
      if (!audioLoaded || isBuffering) return;
      const progressPercent = parseFloat(progressBar.value);
      const targetTime = (progressPercent / 100) * totalDuration;
      jumpToTime(targetTime);
    }
    
    // 网络环境专用跳转逻辑（核心修复）
    function jumpToTime(targetTime) {
      if (!audioLoaded) return;
      
      // 限制时间范围
      const clampedTime = Math.max(0, Math.min(totalDuration, targetTime));
      if (Math.abs(clampedTime - lastValidTime) < 1) return; // 忽略微小调整
      
      showLoading(true);
      isBuffering = true;
      const wasPlaying = isPlaying;
      audioPlayer.pause();
      
      // 关键策略：分阶段加载（针对不支持范围请求的服务器）
      const loadInChunks = () => {
        // 先尝试直接跳转
        audioPlayer.currentTime = clampedTime;
        
        // 检查跳转是否成功
        setTimeout(() => {
          // 情况1：跳转成功（时间误差小于1秒）
          if (Math.abs(audioPlayer.currentTime - clampedTime) < 1) {
            lastValidTime = clampedTime;
            updateProgress();
            isBuffering = false;
            showLoading(false);
            if (wasPlaying) audioPlayer.play();
            return;
          }
          
          // 情况2：跳转失败，使用渐进式缓冲（针对流式音频）
          if (audioPlayer.currentTime < clampedTime) {
            // 先播放到目标位置附近再暂停（模拟跳转）
            audioPlayer.play();
            const checkPoint = setInterval(() => {
              if (audioPlayer.currentTime >= clampedTime - 1 || !isBuffering) {
                clearInterval(checkPoint);
                audioPlayer.pause();
                lastValidTime = audioPlayer.currentTime;
                updateProgress();
                isBuffering = false;
                showLoading(false);
                if (wasPlaying) audioPlayer.play();
              }
            }, 500);
          } else {
            // 异常情况处理
            lastValidTime = clampedTime;
            updateProgress();
            isBuffering = false;
            showLoading(false);
            if (wasPlaying) audioPlayer.play();
          }
        }, 1000); // 给服务器1秒响应时间
      };
      
      // 执行分阶段加载
      loadInChunks();
    }
    
    // 进度条拖动控制
    function handleProgressStart() {
      if (!audioLoaded || totalDuration <= 0 || isBuffering) return;
      
      isDragging = true;
      if (isPlaying) {
        audioPlayer.pause();
      }
    }
    
    function handleProgressDrag() {
      if (!audioLoaded || !isDragging || totalDuration <= 0) return;
      
      const progressPercent = parseFloat(progressBar.value);
      const clampedPercent = Math.max(0, Math.min(100, progressPercent));
      const targetTime = (clampedPercent / 100) * totalDuration;
      
      progressBar.style.setProperty('--progress', `${clampedPercent}%`);
      currentTimeEl.textContent = formatTime(targetTime);
    }
    
    function handleProgressEnd() {
      if (!audioLoaded || !isDragging || totalDuration <= 0) {
        isDragging = false;
        return;
      }
      
      isDragging = false;
      jumpToProgress();
    }
    
    // 播放结束处理
    function handleAudioEnded() {
      pauseAudio();
      lastValidTime = 0;
      audioPlayer.currentTime = 0;
      updateProgress();
    }
    
    // 显示加载状态
    function showLoading(show) {
      loadingIndicator.classList.toggle('active', show);
    }
    
    // 绑定事件
    function bindEvents() {
      playPauseBtn.addEventListener('click', () => isPlaying ? pauseAudio() : playAudio());
      rewindBtn.addEventListener('click', rewind20s);
      forwardBtn.addEventListener('click', forward10s);
      
      // 进度条事件
      progressBar.addEventListener('mousedown', handleProgressStart);
      progressBar.addEventListener('touchstart', (e) => {
        e.preventDefault();
        handleProgressStart();
      });
      progressBar.addEventListener('input', handleProgressDrag);
      progressBar.addEventListener('mouseup', handleProgressEnd);
      progressBar.addEventListener('touchend', (e) => {
        e.preventDefault();
        handleProgressEnd();
      });
      
      audioPlayer.addEventListener('ended', handleAudioEnded);
      audioPlayer.addEventListener('waiting', () => showLoading(true));
      audioPlayer.addEventListener('playing', () => showLoading(false));
      
      // 键盘控制
      document.addEventListener('keydown', (e) => {
        if (e.code === 'Space') {
          e.preventDefault();
          isPlaying ? pauseAudio() : playAudio();
        } else if (e.code === 'ArrowLeft') {
          e.preventDefault();
          rewind20s();
        } else if (e.code === 'ArrowRight') {
          e.preventDefault();
          forward10s();
        }
      });
    }
    
    // 初始化
    window.addEventListener('DOMContentLoaded', () => {
      initDarkMode();
      const params = parseURLParams();
      handleParams(params);
      bindEvents();
    });
  </script>
</body>
</html>